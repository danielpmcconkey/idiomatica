@page "/ModalWord"
@rendermode InteractiveServer
@inject BookService BookService;
@inject UserService UserService;

@* Modal for word management *@
<Modal @ref="modal" Title="@_modalTitle" Size="ModalSize.Large">
    <BodyTemplate>
        <div>
            <label for="inputTranslation" class="form-label">Translation</label>
            <textarea rows="4"
                      cols="150"
                      class="form-control"
                      id="inputTranslation"
                      @bind="_modalWordUser.Translation"
                      @bind:event="oninput">
                        </textarea>
        </div>
        <div>
            <label class="form-label">Word status</label><br />
            <span class="readToken @GetTokenClass(AvailableWordUserStatus.UNKNOWN) @GetTokenClassSelected(8)"
                  @onclick="@(e => UpdateWordStatusSelected(8))">
                @UserService.GetUILabel($"statusLabel{8}")
            </span>
            <span class="readToken @GetTokenClass(AvailableWordUserStatus.NEW1) @GetTokenClassSelected(1)"
                  @onclick="@(e => UpdateWordStatusSelected(1))">
                @UserService.GetUILabel($"statusLabel{1}")
            </span>
            <span class="readToken @GetTokenClass(AvailableWordUserStatus.NEW2) @GetTokenClassSelected(2)"
                  @onclick="@(e => UpdateWordStatusSelected(2))">
                @UserService.GetUILabel($"statusLabel{2}")
            </span>
            <span class="readToken @GetTokenClass(AvailableWordUserStatus.LEARNING3) @GetTokenClassSelected(3)"
                  @onclick="@(e => UpdateWordStatusSelected(3))">
                @UserService.GetUILabel($"statusLabel{3}")
            </span>
            <span class="readToken @GetTokenClass(AvailableWordUserStatus.LEARNING4) @GetTokenClassSelected(4)"
                  @onclick="@(e => UpdateWordStatusSelected(4))">
                @UserService.GetUILabel($"statusLabel{4}")
            </span>
            <span class="readToken @GetTokenClass(AvailableWordUserStatus.LEARNED) @GetTokenClassSelected(5)"
                  @onclick="@(e => UpdateWordStatusSelected(5))">
                @UserService.GetUILabel($"statusLabel{5}")
            </span>
            <span class="readToken @GetTokenClass(AvailableWordUserStatus.IGNORED) @GetTokenClassSelected(6)"
                  @onclick="@(e => UpdateWordStatusSelected(6))">
                @UserService.GetUILabel($"statusLabel{6}")
            </span>
            <span class="readToken @GetTokenClass(AvailableWordUserStatus.WELLKNOWN) @GetTokenClassSelected(7)"
                  @onclick="@(e => UpdateWordStatusSelected(7))">
                @UserService.GetUILabel($"statusLabel{7}")
            </span>
        </div>

    </BodyTemplate>
    <FooterTemplate>
        <Button Color="ButtonColor.Secondary" @onclick="OnHideModalClick">
            @UserService.GetUILabel("closeButton")
        </Button>
        <Button Color="ButtonColor.Primary" @onclick="OnSaveModal">
            @UserService.GetUILabel("saveButton")
        </Button>
    </FooterTemplate>
</Modal>

@code {
    [Parameter]
    public Dictionary<string, WordUser> allWordUsersInLanguage { get; set; }
    [Parameter]
    public Read? Parent { get; set; }
    private Modal modal = default!;
    private Token _modalToken = new Token()
        {
            Display = "",
            Id = 0,
            SentenceId = 0,
            WordId = 0,
            Word = new Word()
            {
                Id = 0,
                LanguageId = 0,
                Language = null,
                Romanization = "",
                Text = "",
                TextLowerCase = ""
            }
        };
    private WordUser _modalWordUser
    {
        get
        {
            if (!allWordUsersInLanguage.ContainsKey(_modalToken.Word.TextLowerCase))
            {
                // this logic should have been done in the paragraphview so this is probably not needed
                // first create
                BookService.WordUserCreateAndSave(_languageUser, _modalToken.Word);
                // pull from the DB fresh
                var newWordUser = BookService.WordUserFetch(_languageUser, _modalToken.Word);
                // and add to the dict
                allWordUsersInLanguage[_modalToken.Word.TextLowerCase] = newWordUser;
            }
            return allWordUsersInLanguage[_modalToken.Word.TextLowerCase];
        }
    }
    private string? _modalTitle
    {
        get
        {
            return _modalToken.Word.TextLowerCase;
        }
    }
    private string? _modalTranslation
    {
        get
        {
            return _modalWordUser.Translation;
        }
    }
    private string? _modalSelectedStatus
    {
        get
        {
            var statusString = UserService.GetUILabel($"statusLabel{(int)_modalWordUser.Status}");
            return statusString;
        }
    }
    private int _modalSelectedStatusValue
    {
        get
        {
            return (int)_modalWordUser.Status;
        }
    }
    private User _loggedInUser
    {
        get // todo: move _loggedInUser population to an initializer
        {
            return UserService.GetLoggedInUser();
        }
    }
    private LanguageUser _languageUser
    {
        get // todo: move _languageUser population to an initializer
        {
            return BookService.LanguageUserFetch((int)_loggedInUser.Id, _modalToken.Word.LanguageId);
        }
    }
    public async Task OnShowModalClick(Token thisToken)
    {
        _modalToken = thisToken;        
        await modal.ShowAsync();
    }
    private string GetTokenClassSelected(int statusToCheck)
    {
        if (_modalWordUser is null) return "unselectedWordStatus";
        if ((int)_modalWordUser.Status == statusToCheck) return "selectedWordStatus";
        return "unselectedWordStatus";
    }
    private async Task OnHideModalClick()
    {
        await modal.HideAsync();
    }

    private async Task OnSaveModal()
    {
        BookService.WordUserUpdateStatusAndTranslation(
            _modalWordUser.Id, _modalWordUser.Status, _modalWordUser.Translation);
        Parent.RefreshState();
        await modal.HideAsync();
    }
    private void UpdateWordStatusSelected(int newStatusInt)
    {
        if (_modalWordUser is null) return;
        _modalWordUser.Status = (AvailableWordUserStatus)newStatusInt;
    }
    private string GetTokenClass(AvailableWordUserStatus status)
    {
        if (status == AvailableWordUserStatus.UNKNOWN) return "statusUNKNOWN";
        if (status == AvailableWordUserStatus.NEW1) return "statusNEW1";
        if (status == AvailableWordUserStatus.NEW2) return "statusNEW2";
        if (status == AvailableWordUserStatus.LEARNING3) return "statusLEARNING3";
        if (status == AvailableWordUserStatus.LEARNING4) return "statusLEARNING4";
        if (status == AvailableWordUserStatus.LEARNED) return "statusLEARNED";
        if (status == AvailableWordUserStatus.WELLKNOWN) return "statusWELLKNOWN";
        if (status == AvailableWordUserStatus.IGNORED) return "statusIGNORED";
        return "statusUNKNOWN";
    }

}
