@page "/Books"
@rendermode InteractiveServer
@inject BookService BookService;
@inject UserService UserService;
@inject IDbContextFactory<IdiomaticaContext> DbContextFactory

<link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet">
<style>
    .sort-th {
        cursor: pointer;
    }
    .fa {
        float: right;
    }    
</style>
<ErrorAlert ErrorState="errorState"></ErrorAlert>
<AuthorizeView>
    <Authorized>
        
        <div class="form-group mb-2">
            <input class="form-control" type="text" placeholder="@UserService.GetUILabel("bookListFormFilter")"
                   @bind="_filter"
                   @bind:event="oninput" />
        </div>
        @if (_isLoading)
        {
            <p>
                @UserService.GetUILabel("loading")
            </p>
        }
        else if (!BookService.BookListRows.Any())
        {
            <p>
                @UserService.GetUILabel("bookListNoBookNotice")
            </p>
            @* todo: add an "add books" button *@
        }
        else
        {

            <table class="table table-striped table-bordered table-hover">
                <thead class="thead-light">
                    <tr>
                        <th scope="col" class="sort-th" @onclick="@(() => OnSortTableClickAsync("Id"))">
                            #
                            <span class="fa @(OnSetSortIcon("Id"))"></span>
                        </th>
                        <th scope="col" class="sort-th" @onclick="@(() => OnSortTableClickAsync("Language"))">
                            @UserService.GetUILabel("bookListLanguageColumnHead")
                            <span class="fa @(OnSetSortIcon("Language"))"></span>
                        </th>
                        <th scope="col" class="sort-th text-center" @onclick="@(() => OnSortTableClickAsync("ISCOMPLETE"))">
                            @UserService.GetUILabel("bookListCompletedColumnHead")
                            <span class="fa @(OnSetSortIcon("ISCOMPLETE"))"></span>
                        </th>
                        <th scope="col" class="sort-th" @onclick="@(() => OnSortTableClickAsync("Title"))">
                            @UserService.GetUILabel("bookListTitleColumnHead")
                            <span class="fa @(OnSetSortIcon("Title"))"></span>
                        </th>
                        <th scope="col" class="sort-th text-center" @onclick="@(() => OnSortTableClickAsync("PROGRESSPERCENT"))">
                            @UserService.GetUILabel("bookListProgressColumnHead")
                            <span class="fa @(OnSetSortIcon("PROGRESSPERCENT"))"></span>
                        </th>
                        <th scope="col" class="sort-th text-end" @onclick="@(() => OnSortTableClickAsync("TOTALWORDCOUNT"))">
                            @UserService.GetUILabel("bookListTotalWordCountColumnHead")
                            <span class="fa @(OnSetSortIcon("TOTALWORDCOUNT"))"></span>
                        </th>
                        <th scope="col" class="sort-th text-end" @onclick="@(() => OnSortTableClickAsync("TOTALKNOWNPERCENT"))">
                            @UserService.GetUILabel("bookListTotalKnownPercentColumnHead")
                            <span class="fa @(OnSetSortIcon("TOTALKNOWNPERCENT"))"></span>
                        </th>
                        <th scope="col" class="sort-th text-end" @onclick="@(() => OnSortTableClickAsync("DISTINCTWORDCOUNT"))">
                            @UserService.GetUILabel("bookListDistinctWordCountColumnHead")
                            <span class="fa @(OnSetSortIcon("DISTINCTWORDCOUNT"))"></span>
                        </th>
                        <th scope="col" class="sort-th text-end" @onclick="@(() => OnSortTableClickAsync("DISTINCTKNOWNPERCENT"))">
                            @UserService.GetUILabel("bookListDistinctKnownPercentColumnHead")
                            <span class="fa @(OnSetSortIcon("DISTINCTKNOWNPERCENT"))"></span>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var row in BookService.BookListRows)
                    {
                        if (!OnIsVisibleInListCheck(row.LanguageName, row.Title))
                            continue;

                        <tr>
                            <td scope="row">@row.BookId</td>
                            <td scope="row">@row.LanguageName</td>
                            <td scope="row" class="text-center">
                                @if (OnFormatIsComplete(row.IsComplete))
                                {
                                    <span class="completedMarker">&#x2713;</span>
                                }
                            </td>
                            <td scope="row">
                                <p>
                                    @OnFormatTitle(row.Title)
                                </p>
                                <p>
                                    <Button Color="ButtonColor.Primary"
                                            Type="ButtonType.Link"
                                            Size="Size.Small"
                                            To="@OnGetBookLinkRead(row.BookId)">
                                        Read
                                    </Button>
                                    <Button Color="ButtonColor.Secondary"
                                            Type="ButtonType.Link"
                                            Size="Size.Small"
                                            To="@OnGetBookLinkUpdate(row.BookId)">
                                        Update
                                    </Button>
                                    <Button Color="ButtonColor.Warning"
                                            Size="Size.Small"
                                            @onclick="((args) => OnClickRemove(args, row.BookId))">
                                        Remove
                                    </Button>
                                    
                                    
                                </p>
                            </td>
                            <td scope="row" class="text-center">@OnFormatProgress(row.Progress)</td>
                            <td scope="row" class="text-end">@OnFormatCount(row.TotalWordCount)</td>
                            <td scope="row" class="text-end">@OnFormatCount(row.TotalKnownPercent)</td>
                            <td scope="row" class="text-end">@OnFormatCount(row.DistinctWordCount)</td>
                            <td scope="row" class="text-end">@OnFormatCount(row.DistinctKnownPercent)</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </Authorized>
    <NotAuthorized>
        <p>@UserService.GetUILabel("notLoggedIn")</p>
    </NotAuthorized>
</AuthorizeView>

@code {

    public ErrorState errorState = new ErrorState() { isError = false, errorMessage = "" };
    private bool _isLoading = false;




    #region sorting and filtering
    private string _filter;
    private bool _isSortedAscending;
    private string _activeSortColumn;

    #endregion







    protected override async Task OnInitializedAsync()
    {
        try
        {
            _isLoading = true;
            var t_delay = Task.Delay(BookService.LoadingDelayMiliseconds);
            var context = await DbContextFactory.CreateDbContextAsync();
            await BookService.InitDataBookList(context, UserService);
            await t_delay;
            _isLoading = false;

        }
        catch (IdiomaticaException ex)
        {
            errorState.isError = true;
            errorState.errorMessage = UserService.GetUILabel("bookListInitializationError");
            errorState.code = ex.code;
            StateHasChanged();
            return;
        }
        catch (Exception ex)
        {
            errorState.isError = true;
            errorState.errorMessage = UserService.GetUILabel("bookListInitializationError");
            StateHasChanged();
        }
    }
    private string OnFormatTitle(string? title)
    {
        try
        {
            if (title == null) return null;
            int maxCharsInBookListTitle = 60;
            if (title.Length > maxCharsInBookListTitle)
            {
                title = title.Substring(0, maxCharsInBookListTitle) + "...";
            }
            return title;
        }
        catch (IdiomaticaException ex)
        {
            errorState.isError = true;
            errorState.errorMessage = UserService.GetUILabel("bookListInitializationError");
            errorState.code = ex.code;
            StateHasChanged();
            return "";
        }
        catch (Exception ex)
        {
            errorState.isError = true;
            errorState.errorMessage = UserService.GetUILabel("bookListInitializationError");
            StateHasChanged();
            return string.Empty;
        }
    }
    private string OnGetBookLinkRead(int? bookId)
    {
        try
        {
            if (bookId == null) return "";
            return $"/Book/{bookId}/Read";
        }
        catch (IdiomaticaException ex)
        {
            errorState.isError = true;
            errorState.errorMessage = UserService.GetUILabel("bookListInitializationError");
            errorState.code = ex.code;
            StateHasChanged();
            return "";
        }
        catch (Exception ex)
        {
            errorState.isError = true;
            errorState.errorMessage = UserService.GetUILabel("bookListInitializationError");
            StateHasChanged();
            return string.Empty;
        }
    }
    private string OnGetBookLinkUpdate(int? bookId)
    {
        try
        {
            if (bookId == null) return "";
            return $"/Book/{bookId}/Update";
        }
        catch (IdiomaticaException ex)
        {
            errorState.isError = true;
            errorState.errorMessage = UserService.GetUILabel("bookListInitializationError");
            errorState.code = ex.code;
            StateHasChanged();
            return "";
        }
        catch (Exception ex)
        {
            errorState.isError = true;
            errorState.errorMessage = UserService.GetUILabel("bookListInitializationError");
            StateHasChanged();
            return string.Empty;
        }
    }
    private void OnClickRemove(EventArgs args, int? bookId)
    {
        try
        {
            throw new NotImplementedException("book removal not yet implemented");

        }
        catch (IdiomaticaException ex)
        {
            errorState.isError = true;
            errorState.errorMessage = UserService.GetUILabel("bookListRemoveBookError");
            errorState.code = ex.code;
            StateHasChanged();
            return;
        }
        catch (Exception ex)
        {
            errorState.isError = true;
            errorState.errorMessage = UserService.GetUILabel("bookListRemoveBookError");
            StateHasChanged();
        }

    }
    private bool OnIsVisibleInListCheck(string? languageName, string? title)
    {
        try
        {
            if (string.IsNullOrEmpty(_filter))
                return true;

            string languageNameNotNull = languageName == null ? "" : (string)languageName;
            string titleNotNull = title == null ? "" : (string)title;
            if (languageNameNotNull.Contains(_filter, StringComparison.OrdinalIgnoreCase))
                return true;
            if (titleNotNull.Contains(_filter, StringComparison.OrdinalIgnoreCase))
                return true;
            return false;
        }
        catch (IdiomaticaException ex)
        {
            errorState.isError = true;
            errorState.errorMessage = UserService.GetUILabel("bookListIsVisibleError");
            errorState.code = ex.code;
            StateHasChanged();
            return false;
        }
        catch (Exception ex)
        {
            errorState.isError = true;
            errorState.errorMessage = UserService.GetUILabel("bookListIsVisibleError");
            StateHasChanged();
            return false;
        }
    }
    private async Task OnSortTableClickAsync(string columnName)
    {
        try
        {
            if (_activeSortColumn == columnName)
            {
                // just change the direction
                _isSortedAscending = !_isSortedAscending;
            }
            else
            {
                // change the column and reset to ascending
                _activeSortColumn = columnName;
                _isSortedAscending = true;
            }
            await BookService.BookListRowsSort(columnName, _activeSortColumn, _isSortedAscending);
        }
        catch (IdiomaticaException ex)
        {
            errorState.isError = true;
            errorState.errorMessage = UserService.GetUILabel("bookListSortTableError");
            errorState.code = ex.code;
            StateHasChanged();
            return;
        }
        catch (Exception ex)
        {
            errorState.isError = true;
            errorState.errorMessage = UserService.GetUILabel("bookListSortTableError");
            StateHasChanged();
        }

    }
    private string OnSetSortIcon(string columnName)
    {
        try
        {
            if (_activeSortColumn != columnName)
            {
                return string.Empty;
            }
            if (_isSortedAscending)
            {
                return "fa-sort-up";
            }
            else
            {
                return "fa-sort-down";
            }
        }
        catch (IdiomaticaException ex)
        {
            errorState.isError = true;
            errorState.errorMessage = UserService.GetUILabel("bookListInitializationError");
            errorState.code = ex.code;
            StateHasChanged();
            return "";
        }
        catch (Exception ex)
        {
            errorState.isError = true;
            errorState.errorMessage = UserService.GetUILabel("bookListInitializationError");
            StateHasChanged();
            return string.Empty;
        }
    }
    private string OnFormatCount(decimal? dbStat)
    {
        try
        {
            if (dbStat is null) return "0";
            var flooredVal = Math.Floor((decimal)dbStat);
            return flooredVal.ToString("N0");
        }
        catch (IdiomaticaException ex)
        {
            errorState.isError = true;
            errorState.errorMessage = UserService.GetUILabel("bookListInitializationError");
            errorState.code = ex.code;
            StateHasChanged();
            return "";
        }
        catch (Exception ex)
        {
            errorState.isError = true;
            errorState.errorMessage = UserService.GetUILabel("bookListInitializationError");
            StateHasChanged();
            return string.Empty;
        }
    }
    private string OnFormatProgress(string? progress)
    {
        try
        {
            if (progress is null) return "0 / 0";
            return progress;
        }
        catch (IdiomaticaException ex)
        {
            errorState.isError = true;
            errorState.errorMessage = UserService.GetUILabel("bookListInitializationError");
            errorState.code = ex.code;
            StateHasChanged();
            return "";
        }
        catch (Exception ex)
        {
            errorState.isError = true;
            errorState.errorMessage = UserService.GetUILabel("bookListInitializationError");
            StateHasChanged();
            return string.Empty;
        }
    }
    private bool OnFormatIsComplete(string? isComplete)
    {
        try
        {
            
            if (isComplete is null) return false;
            bool outVal = false;
            if (bool.TryParse(isComplete, out outVal) == false) return false;
            return outVal;
        }
        catch (IdiomaticaException ex)
        {
            errorState.isError = true;
            errorState.errorMessage = UserService.GetUILabel("bookListInitializationError");
            errorState.code = ex.code;
            StateHasChanged();
            return false;
        }
        catch (Exception ex)
        {
            errorState.isError = true;
            errorState.errorMessage = UserService.GetUILabel("bookListInitializationError");
            StateHasChanged();
            return false;
        }
    }
}
